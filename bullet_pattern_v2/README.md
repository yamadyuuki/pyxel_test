# Pyxel 弾幕パターンデモ

このプロジェクトは、Pythonのレトロゲームエンジン[Pyxel](https://github.com/kitao/pyxel)を使用して、様々な弾幕パターンを実装・表示するためのデモです。

## 実行方法

```bash
pip install pyxel
python main.py
```

## 操作方法

-   **ゲーム開始**: タイトル画面で `SPACE` キーを押します。
-   **終了**: `ESC` キーを押します。
-   **弾幕パターンの選択**: 画面右側のメニューから、試したいパターンをマウスでクリックします。

## 弾幕の実装について

このデモの弾幕は、いくつかのコンポーネントが連携することで実現されています。特徴は、弾幕の振る舞いを定義するロジックと、具体的なパラメータ（弾数、速度など）を分離したデータ駆動型の設計を採用している点です。

### 主要コンポーネント

-   `main.py`: アプリケーション全体のエントリーポイント。ゲームループとシーン（タイトル/ゲーム中）の管理を行います。
-   `core/world.py`: プレイヤー、敵、弾などのゲームオブジェクト全体を管理するクラス。
-   `core/bullet.py` (`BulletSystem`):
    -   全ての弾をオブジェクトプールで管理します。これにより、弾が生成・破棄されるたびにメモリ確保/解放が走るのを防ぎ、パフォーマンスを安定させます。
    -   弾の生成 (`spawn`)、フレームごとの位置更新 (`update`)、画面外に出た弾の無効化、描画 (`draw`) を担当します。
-   `core/emitter.py` (`Emitter`):
    -   「弾を射出するもの」を表すクラス。敵キャラクターなどがこのインスタンスを保持します。
    -   現在アクティブな弾幕パターンを保持し、そのパターンに従って弾を発射する役割を持ちます。
-   `core/patterns.py`:
    -   個々の弾幕パターンの具体的なロジックを定義するクラス群（`Circular`, `AimedBurst`, `Spinner`など）が格納されています。
    -   全てのパターンクラスは `BasePattern` を継承し、`update_and_fire` メソッドを実装します。このメソッド内で、角度やタイミングを計算し、`BulletSystem` の `spawn` メソッドを呼び出して弾を生成します。
-   `data/*.json`:
    -   弾幕パターンの詳細な設定を定義するデータファイルです。例えば、「円形に16発の弾を、速度1.8で、30フレーム間隔で発射する」といったパラメータがJSON形式で記述されています。

### 処理フロー

弾幕が発射されるまでの流れは以下の通りです。

1.  **起動とデータ読み込み**:
    -   `World` クラスが初期化される際に `data/patterns_demo.json` を読み込みます。
    -   このJSONデータをもとに `PatternFactory` が生成され、`Emitter`（射出器）に渡されます。

2.  **パターンの選択**:
    -   プレイヤーがUI上で弾幕パターン（例: `circular_16`）を選択すると、`Emitter.set_pattern("circular_16")` が呼び出されます。

3.  **パターンオブジェクトの生成**:
    -   `Emitter` は `PatternFactory` を使って、指定された名前 (`circular_16`) に対応するパターンオブジェクト（この場合は `Circular` クラスのインスタンス）を生成します。
    -   このとき、JSONに定義されたパラメータ（`bullet_speed`, `count` など）が `Circular` インスタンスに渡されます。

4.  **弾の発射**:
    -   ゲームのメインループが毎フレーム `Emitter.update()` を呼び出します。
    -   `Emitter` は、現在アクティブなパターンオブジェクト（`Circular` インスタンス）の `update_and_fire()` メソッドを実行します。
    -   `update_and_fire()` メソッドは、自身のロジック（例: 「30フレームに1回、円形に弾を配置する」）に基づき、計算した位置と速度で `emitter.bullets.spawn()` を呼び出します。

5.  **弾の生成と管理**:
    -   `BulletSystem` は、`spawn` が呼ばれると、非アクティブな `Bullet` オブジェクトをプールから取り出して再利用し、指定されたパラメータで初期化して「アクティブ」状態にします。
    -   以降、`BulletSystem` がアクティブな弾すべての移動処理と描画を管理します。

### データ駆動設計の利点

このアーキテクチャにより、新しい弾幕パターンを追加する作業が非常に簡単になります。

1.  `patterns.py` に `BasePattern` を継承した新しいロジッククラスを追加する。
2.  `data/patterns_demo.json` に新しいパターンの名前とパラメータを定義する。
3.  `PatternFactory` に新しい型を認識させる分岐を追加する。

これだけで、アプリケーションの他の部分を修正することなく、新しい弾幕をテスト・追加できます。

## ディレクトリ構成

```
.
├── main.py             # メインスクリプト
├── core/               # ゲームのコアロジック
│   ├── bullet.py       # 弾の管理システム
│   ├── emitter.py      # 弾の射出装置
│   ├── patterns.py     # 弾幕パターンのロジック
│   ├── player.py       # プレイヤー
│   ├── timeline.py     # タイムラインイベント
│   ├── ui.py           # UIコンポーネント
│   └── world.py        # ゲームワールド
├── data/               # データファイル
│   ├── patterns_demo.json  # 弾幕パターンの定義
│   └── stage01.json        # ステージ構成
└── assets/             # (未使用) 画像や音声などのアセット用
```
